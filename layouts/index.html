<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ .Title }}</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container">
    <h1>{{ .Title }}</h1>
    <p><strong>100 % private:</strong> everything runs in your browser.</p>

    <div class="decoder">
      <input type="file" id="file" accept="image/*">
      <canvas id="can" style="display:none;"></canvas>
    </div>

    <div id="result" class="result">
      <p class="placeholder">Upload a photo to decode its colour...</p>
    </div>

    <hr>

    <h2>Daily Poo Facts</h2>
    <p><a href="/posts/">Browse the archive â†’</a></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/colorthief@2.3.2/dist/color-thief.umd.js"></script>
<script>
  const fileInput = document.getElementById('file');
  const canvas    = document.getElementById('can');
  const ctx       = canvas.getContext('2d');
  const resultDiv = document.getElementById('result');

  function rgbToHex(r,g,b){
    return "#"+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
  }
  function rgb2hsl(r,g,b){
    r/=255; g/=255; b/=255;
    const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min;
    let h=0,l=(max+min)/2,s=0;
    if(d){ s = l>0.5 ? d/(2-max-min) : d/(max+min);
     switch(max){
       case r: h=(g-b)/d+(g<b?6:0); break;
       case g: h=(b-r)/d+2; break;
       case b: h=(r-g)/d+4; break;
     }
     h*=60;
    }
    return [h,s,l];
  }
  function classify(h){
    if(h<20||h>340) return ['red','Red / Maroon'];
    if(h<40)       return ['brown','Normal Brown'];
    if(h<75)       return ['yellow','Yellow'];
    if(h<150)      return ['green','Green'];
    if(h<260)      return ['black','Black'];
    return ['pale','Pale / Clay'];
  }

  fileInput.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;
    resultDiv.innerHTML = ''; // clear
    const img = new Image();
    img.onload = () => {
      canvas.width  = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
      let colorThief = new ColorThief();
      let rgb;
      try {
        rgb = colorThief.getColor(canvas);
      } catch(err) {
        resultDiv.innerHTML = '<p class="error">Error analysing image. Try a clearer photo.</p>';
        return;
      }
      const [r,g,b] = rgb;
      const hex     = rgbToHex(r,g,b);
      const [h,s,l] = rgb2hsl(r,g,b);
      const [key, title] = classify(h);
      fetch('/blurbs.json')
        .then(r=>r.json())
        .then(blurbs=>{
          const blurb = blurbs[key] || 'No explanation available.';
          resultDiv.innerHTML = `
            <div class="swatch" style="background:${hex}"></div>
            <h3>${title}</h3>
            <p><strong>RGB:</strong> ${r}, ${g}, ${b}</p>
            <p><strong>HEX:</strong> ${hex}</p>
            <p><strong>HSL:</strong> ${h.toFixed(0)}, ${(s*100).toFixed(0)}%, ${(l*100).toFixed(0)}%</p>
            <p>${blurb}</p>
          `;
        });
    };
    img.src = URL.createObjectURL(file);
  };
</script>
  </body>
</html>