<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ .Title }}</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="container">
    <h1>{{ .Title }}</h1>
    <p><strong>100 % private:</strong> everything runs in your browser.</p>

    <div class="decoder">
      <input type="file" id="file" accept="image/*">
      <canvas id="can" style="display:none;"></canvas>
    </div>

    <div id="result" class="result">
      <p class="placeholder">Upload a photo to decode its colour‚Ä¶</p>
    </div>

    <hr>

    <h2>Daily Poo Facts</h2>
    <p><a href="/posts/">Browse the archive ‚Üí</a></p>
  </div>

  <script>
    console.log("‚ñ∂Ô∏è Decoder script loaded");

    const fileInput = document.getElementById('file');
    const canvas    = document.getElementById('can');
    const ctx       = canvas.getContext('2d');
    const resultDiv = document.getElementById('result');

    function rgbToHex(r,g,b){
      return "#" + [r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
    }

    function rgb2hsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min;
      let h=0,s=0,l=(max+min)/2;
      if(d){
        s = l>0.5 ? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d + (g<b?6:0); break;
          case g: h=(b-r)/d + 2; break;
          case b: h=(r-g)/d + 4; break;
        }
        h *= 60;
      }
      return [h,s,l];
    }

    function classify(h){
      if(h<20||h>340) return {key:'red', title:'Red / Maroon'};
      if(h<40)       return {key:'brown', title:'Normal Brown'};
      if(h<75)       return {key:'yellow', title:'Yellow'};
      if(h<150)      return {key:'green', title:'Green'};
      if(h<260)      return {key:'black', title:'Black'};
      return {key:'pale', title:'Pale / Clay'};
    }

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if(!file) return;
      console.log("üìÇ File selected:", file.name);

      resultDiv.innerHTML = '';  // clear placeholder

      const img = new Image();
      img.onload = () => {
        // draw into canvas
        canvas.width  = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img, 0, 0);

        // sample center pixel
        const x = Math.floor(canvas.width / 2);
        const y = Math.floor(canvas.height / 2);
        const [r, g, b] = ctx.getImageData(x, y, 1, 1).data;
        console.log("üé® Center pixel:", r, g, b);

        const hex = rgbToHex(r, g, b);
        const [h, s, l] = rgb2hsl(r, g, b);
        const {key, title} = classify(h);

        console.log("üîç Fetching blurbs.json");
        fetch('/blurbs.json')
          .then(res => {
            console.log("üì• blurbs.json status:", res.status);
            return res.json();
          })
          .then(blurbs => {
            console.log("üìñ blurbs loaded:", blurbs[key]);
            const blurb = blurbs[key] || 'No explanation available.';
            resultDiv.innerHTML = `
              <div class="swatch" style="background:${hex}"></div>
              <h3>${title}</h3>
              <p><strong>RGB:</strong> ${r}, ${g}, ${b}</p>
              <p><strong>HEX:</strong> ${hex}</p>
              <p><strong>HSL:</strong> ${Math.round(h)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%</p>
              <p>${blurb}</p>
            `;
          })
          .catch(err => {
            console.error("‚ùå Error loading blurbs.json:", err);
            resultDiv.innerHTML = '<p class="error">Could not load explanations.</p>';
          });
      };
      img.onerror = err => {
        console.error("‚ùå Image load error:", err);
        resultDiv.innerHTML = '<p class="error">Failed to load image.</p>';
      };
      img.src = URL.createObjectURL(file);
    });
  </script>
</body>
</html>